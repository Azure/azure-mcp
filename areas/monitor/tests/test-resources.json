{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "_generator": {
      "name": "bicep",
      "version": "0.37.4.10188",
      "templateHash": "8837967864368974042"
    }
  },
  "parameters": {
    "baseName": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "minLength": 4,
      "maxLength": 21,
      "metadata": {
        "description": "The base resource name."
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "The location of the resource. By default, this is the same as the resource group."
      }
    },
    "tenantId": {
      "type": "string",
      "defaultValue": "72f988bf-86f1-41af-91ab-2d7cd011db47",
      "metadata": {
        "description": "The tenant ID to which the application and resources belong."
      }
    },
    "testApplicationOid": {
      "type": "string",
      "metadata": {
        "description": "The client OID to grant access to test resources."
      }
    }
  },
  "resources": [
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}/{1}/{2}', format('{0}mon', parameters('baseName')), 'default', 'foo')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', format('{0}mon', parameters('baseName')), 'default')]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}/{1}/{2}', format('{0}mon', parameters('baseName')), 'default', 'bar')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', format('{0}mon', parameters('baseName')), 'default')]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}/{1}/{2}', format('{0}mon', parameters('baseName')), 'default', 'baz')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', format('{0}mon', parameters('baseName')), 'default')]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}/{1}/{2}', format('{0}mon', parameters('baseName')), 'default', 'foo')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/tableServices', format('{0}mon', parameters('baseName')), 'default')]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}/{1}/{2}', format('{0}mon', parameters('baseName')), 'default', 'bar')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/tableServices', format('{0}mon', parameters('baseName')), 'default')]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/tableServices/tables",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}/{1}/{2}', format('{0}mon', parameters('baseName')), 'default', 'baz')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/tableServices', format('{0}mon', parameters('baseName')), 'default')]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}/{1}', format('{0}mon', parameters('baseName')), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}mon', parameters('baseName')))]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts/tableServices",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}/{1}', format('{0}mon', parameters('baseName')), 'default')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}mon', parameters('baseName')))]"
      ]
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2023-09-01",
      "name": "[parameters('baseName')]",
      "location": "[parameters('location')]",
      "properties": {
        "retentionInDays": 30,
        "sku": {
          "name": "PerGB2018"
        },
        "features": {
          "searchVersion": 1,
          "workspaceCapping": "Off"
        },
        "publicNetworkAccessForIngestion": "Enabled",
        "publicNetworkAccessForQuery": "Enabled"
      }
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces/tables",
      "apiVersion": "2022-10-01",
      "name": "[format('{0}/{1}', parameters('baseName'), 'TestLogs_CL')]",
      "properties": {
        "totalRetentionInDays": 30,
        "plan": "Analytics",
        "schema": {
          "name": "TestLogs_CL",
          "columns": [
            {
              "name": "TimeGenerated",
              "type": "datetime",
              "description": "The time the log was generated"
            },
            {
              "name": "Message",
              "type": "string",
              "description": "The log message"
            },
            {
              "name": "Level",
              "type": "string",
              "description": "The log level"
            },
            {
              "name": "Source",
              "type": "string",
              "description": "The source of the log"
            }
          ]
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('baseName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/dataCollectionRules",
      "apiVersion": "2023-03-11",
      "name": "test-dcr",
      "location": "[parameters('location')]",
      "properties": {
        "destinations": {
          "logAnalytics": [
            {
              "workspaceResourceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('baseName'))]",
              "name": "workspace-destination"
            }
          ]
        },
        "dataFlows": [
          {
            "streams": [
              "Custom-TestLogs"
            ],
            "destinations": [
              "workspace-destination"
            ],
            "transformKql": "source",
            "outputStream": "Custom-TestLogs_CL"
          }
        ],
        "streamDeclarations": {
          "Custom-TestLogs": {
            "columns": [
              {
                "name": "TimeGenerated",
                "type": "datetime"
              },
              {
                "name": "Message",
                "type": "string"
              },
              {
                "name": "Level",
                "type": "string"
              },
              {
                "name": "Source",
                "type": "string"
              }
            ]
          }
        }
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('baseName'))]"
      ]
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2022-09-01",
      "name": "[format('{0}mon', parameters('baseName'))]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "properties": {
        "allowSharedKeyAccess": false
      }
    },
    {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', format('{0}mon', parameters('baseName')))]",
      "name": "storage-account-diagnostics",
      "properties": {
        "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('baseName'))]",
        "metrics": [
          {
            "category": "Transaction",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          },
          {
            "category": "Capacity",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}mon', parameters('baseName')))]",
        "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('baseName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}/blobServices/{1}', format('{0}mon', parameters('baseName')), 'default')]",
      "name": "blob-service-diagnostics",
      "properties": {
        "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('baseName'))]",
        "logs": [
          {
            "category": "StorageRead",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          },
          {
            "category": "StorageWrite",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          },
          {
            "category": "StorageDelete",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          }
        ],
        "metrics": [
          {
            "category": "Transaction",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          },
          {
            "category": "Capacity",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', format('{0}mon', parameters('baseName')), 'default')]",
        "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('baseName'))]"
      ]
    },
    {
      "type": "Microsoft.Insights/diagnosticSettings",
      "apiVersion": "2021-05-01-preview",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}/tableServices/{1}', format('{0}mon', parameters('baseName')), 'default')]",
      "name": "table-service-diagnostics",
      "properties": {
        "workspaceId": "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('baseName'))]",
        "logs": [
          {
            "category": "StorageRead",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          },
          {
            "category": "StorageWrite",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          },
          {
            "category": "StorageDelete",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          }
        ],
        "metrics": [
          {
            "category": "Transaction",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          },
          {
            "category": "Capacity",
            "enabled": true,
            "retentionPolicy": {
              "enabled": false,
              "days": 0
            }
          }
        ]
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts/tableServices', format('{0}mon', parameters('baseName')), 'default')]",
        "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('baseName'))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.Storage/storageAccounts/{0}', format('{0}mon', parameters('baseName')))]",
      "name": "[guid(subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe'), parameters('testApplicationOid'), resourceId('Microsoft.Storage/storageAccounts', format('{0}mon', parameters('baseName'))))]",
      "properties": {
        "principalId": "[parameters('testApplicationOid')]",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', 'ba92f5b4-2d11-453d-a403-e96b0029c9fe')]",
        "description": "Blob Contributor for testApplicationOid"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', format('{0}mon', parameters('baseName')))]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.Insights/dataCollectionRules/{0}', 'test-dcr')]",
      "name": "[guid(subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '3913510d-42f4-4e42-8a64-420c390055eb'), parameters('testApplicationOid'), resourceId('Microsoft.Insights/dataCollectionRules', 'test-dcr'))]",
      "properties": {
        "principalId": "[parameters('testApplicationOid')]",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '3913510d-42f4-4e42-8a64-420c390055eb')]",
        "description": "Monitoring Metrics Publisher for DCR ingestion"
      },
      "dependsOn": [
        "[resourceId('Microsoft.Insights/dataCollectionRules', 'test-dcr')]"
      ]
    },
    {
      "type": "Microsoft.Authorization/roleAssignments",
      "apiVersion": "2022-04-01",
      "scope": "[format('Microsoft.OperationalInsights/workspaces/{0}', parameters('baseName'))]",
      "name": "[guid(subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '92aaf0da-9dab-42b6-94a3-d43ce8d16293'), parameters('testApplicationOid'), resourceId('Microsoft.OperationalInsights/workspaces', parameters('baseName')))]",
      "properties": {
        "principalId": "[parameters('testApplicationOid')]",
        "roleDefinitionId": "[subscriptionResourceId('Microsoft.Authorization/roleDefinitions', '92aaf0da-9dab-42b6-94a3-d43ce8d16293')]",
        "description": "Log Analytics Contributor for workspace access"
      },
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', parameters('baseName'))]"
      ]
    }
  ]
}